{% extends "base/base.html" %}
{% block navusuario %}nav-item active{% endblock  %}
{% block collapseUsuarios %}collapse show{% endblock  %}
{% block usuario_list %}collapse-item active{% endblock  %}
{% block pagecontent %}
<div class="container-fluid">

    <div class="card shadow">
      <!-- Card Header - Dropdown -->
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">Listado de Usuarios</h6>
        <a class="btn btn-primary NewUser" href="{% url 'user:create_user' %}"><i
            class="fa fa-plus-circle "></i>&nbsp;Nuevo usuario</a>
      </div>
      <!-- Card Body -->
      <div class="card-body">
    
        <table class="table  table-hover dt-responsive" id="TablaUser" style="width: 100%;">
          <thead>
            <tr>
            <th class="all">Id</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th>Username</th>
            <th>Fecha de registro</th>
            <th>Imagen</th>
            <th>Estado</th>
            <th>Opciones</th>
            </tr>
            
    
          </thead>
    
    
    
        </table>
      </div>
    </div>
    </div>
    
    {% endblock pagecontent %}
    {% block js_page %}
    <script>
        $(document).ready(function () {
            tabla = $("#TablaUser").DataTable({
     responsive:true,
      ajax: {
        url: "{% url 'user:userList' %}",
        type: "POST",
        data: {
          "action": "searchData"
        },
        dataSrc: ""
      },
      "lengthMenu": [
        [5, 10, 25, 50, -1],
        [5, 10, 25, 50, "All"]
      ],
      "language": {
        "sSearch": "Buscar",
        "emptyTable": "No hay datos disponibles para esta tabla",
        "lengthMenu": "Mostrando _MENU_ entradas",
        "loadingRecords": "Cargando...",
        "processing": "Procesando...",
        "zeroRecords": "No se encontraron resultados",
        "info": "Mostrando _START_ al _END_ de _TOTAL_ entradas",
        "infoEmpty": "Mostrando 0 al 0 de 0 entradas",


      },
      "order": [
        [0, 'asc']
      ],
      columns: [{
          "data": 'id',className: "text-center middle",
        },
        {
          "data": 'first_name',className: "middle"
        },
        {
          "data": 'last_name',className: "middle"
        },
        {
          "data": 'username',className: "middle"
        },
        {
          "data": 'date_joined',className: "middle"

        },
        {
          "data": 'image',
          className: "text-center middle",
          render:function(data,type,row){
            return "<img src='"+row.image+"' class='img-fluid mx-auto d-block' style='width:40px;height:40px;'>"

          }
        },
        {
          "data": 'is_active',
          className: "estado middle",
          render: function (data, type, row) {
            if (data) {
              return "Activo";
            } else {
              return "Inactivo"
            }
          }
        },
        {
          "data": 'id',className:"text-center middle"
        },


      ],
      columnDefs: [{
          targets: [-1],

          render: function (row, data, index) {
            var buttons =
              '<a  href="#" class="btn btn-warning btn-circle btnEdit mr-1" role="button" data-url="cliente/edit/' +
              row.id +
              '"><i class="far fa-edit" ></i></a><a class="btn btn-success btn-circle" href="#" target="reportes"><i class="fas fa-thumbs-up"></i></a>';

            return buttons;

          },

        },
       

      ],
      "createdRow": function (row, data, index) {
        if (!data["estado"]) {
          $('.btn-success', row).eq(0).removeClass().addClass("btn btn-danger btn-circle")
          $(".fa-thumbs-up", row).eq(0).removeClass().addClass("fas fa-thumbs-down")

        }
      },

    });
    $('.NewUser').on("click", function (e) {
      e.preventDefault()
      var template = $(this).attr("data-url");
      var jc = $.confirm({
        title: "Nuevo Usuario",
        content: "URL:new",
        columnClass: 'col-lg-8 col-md-10 col-sm-10',
        icon: "fa fa-plus-circle",
        type: "blue",
        scrollToPreviousElement: false,
        buttons: {
          formSubmit: {
            text: 'Registrar Usuario',
            btnClass: 'btn-blue',
            action: function () {
    

              form = this.$content.find('.needs-validation')[0]
              console.log(form)
              var paramaters=new FormData(form)
             
              $.ajax({
                type: "POST",
                url: "{% url 'user:create_user' %}",
                data: paramaters,
                dataType: "json",
                processData: false,  // tell jQuery not to process the data
                contentType: false,
                success: function (data) {
                  console.log(data)
                  if (data["stat"] == "ok") {
                    mensaje("Usuario registrado")
                    jc.close()
                    $("#TablaUser").DataTable().ajax.reload()

                  } else {
                
                    $("#form").html($(data).html())
                 
                    $(":text").keypress(function (e) {
                      $(this).removeClass("is-invalid")
                    });

                    // var go = ""
                    // for (var [key, value] of Object.entries(data.error)) {
                    //   go += '<br>' + value; // "a 5", "b 7", "c 9"
                    // }
                    // mensaje(go, "red")

                  }
                }

              }).done(function (data) {}).fail(function (jqXHR, textStatus, errorThrown) {
                alert("done:" + textStatus + ': ' + errorThrown);
              }).always(function (data) {

              });


              return false;

            }
          },
          cancel: function () {},
        },


      });

    });


        });
    </script>
    {% endblock js_page %}
